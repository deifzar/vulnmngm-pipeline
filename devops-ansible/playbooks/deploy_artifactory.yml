---
- name: Deploy Artifactory with Nginx reverse proxy
  hosts: artifactory_servers
  become: yes

  pre_tasks:
    - name: Verify connection
      ping:

    - name: Gather facts
      setup:

    - name: Display target host information
      debug:
        msg: "Deploying to {{ inventory_hostname }} ({{ ansible_host }})"

  roles:
    - role: security_baseline
      tags: ["security", "baseline"]

    - role: artifactory
      tags: ["artifactory", "app"]

    - role: nginx_reverse_proxy
      vars:
        service_name: "artifactory"
        service_domain: "{{ artifactory_domain }}"
        backend_host: "{{ artifactory_listen_address }}"
        backend_port: "{{ artifactory_port }}"
        websocket_support: true
        proxy_timeout: 90
      tags: ["nginx", "proxy"]

  post_tasks:
    - name: Display completion message
      debug:
        msg: |
          ================================================
          Artifactory deployment completed successfully!
          ================================================
          Access Artifactory at: https://{{ artifactory_domain }}

          Initial admin password has been displayed above.

          Next steps:
          1. Complete Artifactory setup wizard
          2. Configure Artifactory plugins
          3. Set up Artifactory jobs/pipelines
          ================================================
